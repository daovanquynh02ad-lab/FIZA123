<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Физиология: Обмен веществ и энергии</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #F9F9F9;
            --card-bg: #FFFFFF;
            --text-primary: #111111;
            --text-secondary: #555555;
            --accent: #007AFF; /* Синий для Физиологии */
            --accent-light: #F0F8FF;
            --success: #34C759;
            --success-light: #F0FFF4;
            --error: #FF3B30;
            --error-light: #FFF0F0;
            --border: #E5E5E5;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
            --font: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        [data-theme="dark"] {
            --bg: #000000;
            --card-bg: #1C1C1E;
            --text-primary: #FFFFFF;
            --text-secondary: #8D8D93;
            --accent: #0A84FF;
            --accent-light: #2C2C2E;
            --success: #30D158;
            --success-light: #2C2C2E;
            --error: #FF453A;
            --error-light: #2C2C2E;
            --border: #3A3A3C;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        html, body {
            font-family: var(--font);
            background-color: var(--bg);
            color: var(--text-primary);
            min-height: 100vh;
            touch-action: manipulation;
        }

        .container {
            max-width: 640px;
            width: 100%;
            margin: 0 auto;
            padding: 20px 20px 140px 20px;
        }

        /* --- ЭКРАНЫ --- */
        .screen {
            display: none;
            flex-direction: column;
            width: 100%;
            flex: 1;
            animation: fadeIn 0.3s ease-out;
        }
        .screen.active {
            display: flex;
        }
        
        /* --- СТАРТОВЫЙ ЭКРАН --- */
        .start-header {
            margin: 20px 0 30px 0;
            text-align: center;
        }
        .start-header h1 {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 10px;
        }
        .start-header p {
            font-size: 1.1rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        .topic-selector {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 15px;
            margin-bottom: 20px;
        }
        .topic-selector h3 {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 15px;
            padding-left: 10px;
        }
        .topic-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .topic-choice {
            display: flex;
            align-items: center;
            padding: 12px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
            font-size: 0.95rem;
        }
        .topic-choice:hover {
            background-color: var(--bg);
        }
        .topic-choice input {
            transform: scale(1.2);
            margin-right: 12px;
            accent-color: var(--accent);
        }
        .topic-choice span {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-left: auto;
        }
        .select-all-btn {
            background: none;
            border: none;
            color: var(--accent);
            font-weight: 600;
            cursor: pointer;
            padding: 10px;
            font-size: 0.9rem;
        }

        .start-controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .menu-btn {
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            background: var(--card-bg);
            color: var(--text-primary);
            text-align: left;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            touch-action: manipulation;
        }
        .menu-btn:hover {
            border-color: var(--accent);
            background: var(--card-bg);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        .menu-btn.primary {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            font-weight: 700;
        }
        .menu-btn.primary:hover {
            background-color: var(--accent);
            border-color: var(--accent);
        }
        .menu-btn i {
            width: 20px;
            text-align: center;
            color: var(--text-secondary);
        }
        .menu-btn:hover i { color: var(--accent); }
        .menu-btn.primary i { color: white; }

        .top-settings {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .top-controls-group {
            display: flex;
            gap: 10px;
        }
        .theme-toggle {
            background: var(--card-bg);
            border: 2px solid var(--border);
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            touch-action: manipulation;
        }
        .theme-toggle i { font-size: 1.2rem; }
        .theme-toggle:hover {
            color: var(--text-primary);
            border-color: var(--text-primary);
        }
        
        .progress-pill {
            background: var(--card-bg);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        /* --- ЭКРАН ТЕСТА --- */
        .quiz-card {
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            padding: 25px;
            width: 100%;
            border: 1px solid var(--border);
            margin-top: 20px;
        }
        .q-id {
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 8px;
        }
        .q-title {
            font-size: 1.35rem;
            font-weight: 700;
            line-height: 1.4;
            margin-bottom: 30px;
            color: var(--text-primary);
        }
        
        .options-list { display: flex; flex-direction: column; gap: 12px; }
        .option {
            background: var(--bg); border: 2px solid var(--bg); padding: 16px; border-radius: 12px; cursor: pointer;
            font-size: 1rem; font-weight: 500; line-height: 1.4; transition: all 0.2s; display: flex; align-items: center;
            gap: 15px; touch-action: manipulation;
        }
        .option:hover:not(.disabled) { border-color: var(--accent); }
        
        .option-marker {
            width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--border);
            flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: 0.2s; position: relative;
        }
        .option-marker i { font-size: 12px; color: white; opacity: 0; transition: 0.2s; }

        .option.selected:not(.disabled) { border-color: var(--accent); background: var(--accent-light); }
        .option.selected:not(.disabled) .option-marker { background: var(--accent); border-color: var(--accent); }
        .option.selected:not(.disabled) .option-marker i { opacity: 1; content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900; }

        .option.correct { background: var(--success-light); border-color: var(--success); color: var(--text-primary); }
        .option.correct .option-marker { background: var(--success); border-color: var(--success); }
        .option.correct .option-marker i { opacity: 1; content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900; }
        
        .option.incorrect { background: var(--error-light); border-color: var(--error); color: var(--text-primary); }
        .option.incorrect .option-marker { background: var(--error); border-color: var(--error); }
        .option.incorrect .option-marker i { opacity: 1; content: '\f00d'; font-family: "Font Awesome 6 Free"; font-weight: 900; }

        .option.missed { border: 2px dashed var(--success); background: var(--success-light); opacity: 0.8; }
        .option.disabled { cursor: default; }

        /* --- ФУТЕР --- */
        .quiz-footer {
            position: fixed; bottom: 0; left: 0; right: 0; padding: 20px;
            background: linear-gradient(180deg, rgba(255,255,255,0) 0%, var(--card-bg) 30%);
            border-top: 1px solid var(--border);
        }
        [data-theme="dark"] .quiz-footer { background: linear-gradient(180deg, rgba(0,0,0,0) 0%, var(--card-bg) 30%); }

        .quiz-footer .container { padding: 0; }
        .controls { display: grid; grid-template-columns: 50px 1fr 50px 50px; gap: 10px; }
        .nav-btn {
            height: 50px; border-radius: 12px; border: 1px solid var(--border); cursor: pointer; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center; background: var(--card-bg); color: var(--text-primary);
            box-shadow: var(--shadow); touch-action: manipulation;
        }
        .nav-btn:hover:not(:disabled) { background: var(--bg); border-color: var(--accent); }
        .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; box-shadow: none; }
        
        .action-btn {
            height: 50px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; font-size: 1rem; color: white;
            background: var(--accent); box-shadow: var(--shadow); touch-action: manipulation;
        }
        .action-btn:disabled { background: var(--text-secondary); box-shadow: none; opacity: 0.5; }
        .action-btn.correct { background: var(--success); }
        .action-btn.incorrect { background: var(--error); }
        .action-btn:active:not(:disabled) { transform: scale(0.98); }

        /* --- РЕЗУЛЬТАТЫ --- */
        .stat-box { background: var(--card-bg); border: 1px solid var(--border); padding: 15px; border-radius: 12px; text-align: center; box-shadow: var(--shadow); }
        .stat-val { font-size: 1.8rem; font-weight: 700; }
        .stat-label { font-size: 0.9rem; color: var(--text-secondary); }
        .stat-val.correct { color: var(--success); }
        .stat-val.error { color: var(--error); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="container">

        <div id="start-screen" class="screen active">
            <div class="top-settings">
                <span></span>
                <div class="top-controls-group">
                    <a href="https://t.me/stewonly" target="_blank" class="theme-toggle" aria-label="Telegram">
                        <i class="fab fa-telegram-plane"></i>
                    </a>
                    <button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle-btn-start">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
            <div class="start-header">
                <h1>Физиология: Обмен веществ и энергии</h1>
                <p>Тренажер по вопросам 1327-1410.</p>
            </div>
            
            <div class="topic-selector">
                <h3>Выберите темы:</h3>
                <div class="topic-list" id="topic-list">
                    </div>
                <button class="select-all-btn" onclick="toggleSelectAll(this)">Выбрать все</button>
            </div>
            
            <div class="start-controls">
                <div id="resume-block" style="display:none; width: 100%;">
                    <button class="menu-btn primary" onclick="startQuiz('resume')">
                        <i class="fas fa-play"></i> &nbsp; Продолжить
                    </button>
                </div>
                <button class="menu-btn" onclick="startQuiz('new')">
                    <i class="fas fa-redo"></i> &nbsp; Начать (по порядку)
                </button>
                <button class="menu-btn" onclick="startQuiz('shuffle')">
                    <i class="fas fa-random"></i> &nbsp; Случайный порядок
                </button>
                <button class="menu-btn primary" id="mistakes-btn-start" style="display:none;" onclick="startQuiz('mistakes')">
                    <i class="fas fa-bug"></i> &nbsp; Работа над ошибками
                </button>
            </div>
        </div>

        <div id="quiz-screen" class="screen">
            <div class="top-settings" style="margin-bottom: 20px;">
                <div class="progress-pill" id="progress-pill">1 / 50</div>
                <div class="top-controls-group">
                    <a href="https://t.me/stewonly" target="_blank" class="theme-toggle" aria-label="Telegram">
                        <i class="fab fa-telegram-plane"></i>
                    </a>
                    <button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle-btn-quiz">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>

            <div class="quiz-card" id="question-card">
                <div class="q-id" id="q-id-display">Раздел: ...</div>
                <div class="q-title" id="q-text">Загрузка...</div>
                <div class="options-list" id="options-list"></div>
            </div>
        </div>

        <div id="result-screen" class="screen">
             <div class="start-header" style="margin:0;">
                <h1 id="result-title">Тест завершен!</h1>
                <p id="result-subtitle" style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-top: 10px;">Результат: <span id="final-score">0%</span></p>
            </div>
            <div class="result-stats" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; margin: 30px 0;">
                <div class="stat-box">
                    <div class="stat-val correct" id="correct-val">0</div>
                    <div class="stat-label">Верно</div>
                </div>
                <div class="stat-box">
                    <div class="stat-val error" id="error-val">0</div>
                    <div class="stat-label">Ошибки</div>
                </div>
            </div>
            <div class="start-controls" style="margin-top: 20px;">
                 <button class="menu-btn primary" id="mistakes-btn-end" onclick="startQuiz('mistakes')" style="display:none">
                    <i class="fas fa-bug"></i> &nbsp; Работа над ошибками
                </button>
                <button class="menu-btn" onclick="goHome()">
                    <i class="fas fa-home"></i> &nbsp; В главное меню
                </button>
            </div>
        </div>
    </div>

    <div class="quiz-footer" id="quiz-footer" style="display: none;">
        <div class="container" style="padding-bottom: 0;">
             <div class="controls">
                <button class="nav-btn" id="prev-btn" onclick="prevQ()"><i class="fas fa-chevron-left"></i></button>
                <button class="action-btn" id="main-btn" onclick="handleMainClick()">Ответить</button>
                <button class="nav-btn" id="next-btn" onclick="nextQ()"><i class="fas fa-chevron-right"></i></button>
                <button class="nav-btn" id="home-btn" onclick="goHome()"><i class="fas fa-home"></i></button>
            </div>
        </div>
    </div>
    
    <script>
        // --- БАЗА ДАННЫХ ВОПРОСОВ (ФИЗИОЛОГИЯ) ---
        // Ответы взяты из ключей в конце файла (стр. 321-322 исходника)
        
        const topicData = {
            metabolism: {
                name: "Раздел: Обмен веществ",
                questions: [
                    {id:"1327",q:"Обменом веществ называют:",opts:["совокупность реакций биосинтеза веществ в клетке","удаление конечных продуктов обмена веществ во внешнюю среду","выделение пищеварительных соков в желудок и кишечник","совокупность реакции окисления и распада веществ в клетке"],correct:[0]},
                    {id:"1328",q:"Образование сложных органических соединений из простых называется:",opts:["основным обменом","ассимиляцией","катаболизмом","диссимиляцией"],correct:[1]},
                    {id:"1329",q:"Положительный азотистый баланс наблюдается…",opts:["у детей","у голодающих","у взрослых, занимающихся бодибилдингом","у беременных","у пожилых","при выздоровлении после тяжелого заболевания"],correct:[0,2,3,5]},
                    {id:"1330",q:"Что такое нутриенты?",opts:["это компоненты пищи, обеспечивающие поддержание водного баланса организма","это балластные вещества","это защитные вещества","это компоненты пищи, обеспечивающие энергозатраты и синтетические процессы организма"],correct:[3]},
                    {id:"1331",q:"Отрицательный азотистый баланс наблюдается при:",opts:["росте организма","выздоровлении после тяжелого заболевания","чрезмерных нагрузках","беременности","белковом голодании"],correct:[2,4]},
                    {id:"1332",q:"Состояние, при котором количество выведенного азота меньше количества азота, поступившего в организм, называется:",opts:["положительным азотистым балансом","азотистым равновесием","отрицательным азотистым балансом","азотистым коэффициентом"],correct:[0]},
                    {id:"1333",q:"Количество выделяемого за сутки азота на 1 кг массы тела в состоянии покоя при отсутствии белка в пище называется",opts:["дыхательным коэффициентом","коэффициентом изнашивания","коэффициентом полезного действия","константой Гюффнера"],correct:[1]},
                    {id:"1334",q:"Состояние, при котором количество выведенного азота больше количества азота, поступившего в организм, называется:",opts:["отрицательным азотистым балансом","азотистым равновесием","азотистым коэффициентом","положительным азотистым балансом"],correct:[0]},
                    {id:"1335",q:"При отсутствии в потребляемой пище незаменимых аминокислот наблюдается:",opts:["азотистое равновесие","усиление метаболизма углеводов","отрицательный азотистый баланс","положительный азотистый баланс","усиление метаболизма жиров"],correct:[2]},
                    {id:"1336",q:"Мочевина образуется в результате расщепления:",opts:["углеводов","липидов","солей","белков"],correct:[3]},
                    {id:"1337",q:"При беременности потребление белков:",opts:["повышено","снижено","не изменено"],correct:[0]},
                    {id:"1338",q:"Состояние, при котором наблюдается равенство количества выведенного азота и поступившего в организм, называется:",opts:["азотистым равновесием","отрицательным азотистым балансом","азотистым коэффициентом","положительным азотистым балансом"],correct:[0]},
                    {id:"1339",q:"Укажите гормоны, повышающие уровень глюкозы в крови:",opts:["глюкокортикоиды","инсулин","адреналин","глюкагон"],correct:[0,2,3]},
                    {id:"1340",q:"На распад липидов и депонирование их в печени оказывают влияние:",opts:["тироксин","глюкокортикоиды","минералокортикоиды","соматотропный гормон","адреналин"],correct:[0,3,4]},
                    {id:"1341",q:"Укажите органы, где в основном откладывается гликоген:",opts:["скелетные мышцы","селезенка","печень","почки","кожа"],correct:[0,2]},
                    {id:"1342",q:"Наибольшей чувствительностью к гипогликемии обладает...",opts:["центральная нервная система","почка","печень","кожа"],correct:[0]},
                    {id:"1343",q:"При введении инсулина уровень глюкозы в крови уменьшается за счет:",opts:["усиления катаболических реакций","усиления гликогенеза","усиления глюконеогенеза","усиления гликогенолиза"],correct:[1]},
                    {id:"1344",q:"Укажите, усваиваемость какой пищи выше:",opts:["растительной","животной","смешанной"],correct:[2]},
                    {id:"1345",q:"Оптимальное количество белков в суточном рационе взрослого человека умственного труда составляет:",opts:["100-110 г","300-350 г","200-220 г","170-200 г"],correct:[0]},
                    {id:"1346",q:"Гипергликемическим действием обладают гормоны:",opts:["инсулин","глюкагон","адреналин","альдостерон","кортизол"],correct:[1,2,4]},
                    {id:"1347",q:"Гормоном, способствующим гликогенезу в печени является:",opts:["эстрогены","адреналин","инсулин","тироксин"],correct:[2]},
                    {id:"1348",q:"Гипогликемическим действием обладает:",opts:["кальцитонин","адреналин","альдостерон","инсулин"],correct:[3]},
                    {id:"1349",q:"Закономерность, согласно которой отдельные питательные вещества могут заменять друг друга в соответствии с их энергетической ценностью называется...",opts:["правилом изодинамии","правилом поверхности тела","законом Франка-Старлинга","правилом средних нагрузок"],correct:[0]},
                    {id:"1350",q:"Суточная потребность витамина С равна...",opts:["0,5-5 мг","50-100 мг","5-10 мг","20-30 мг"],correct:[1]},
                    {id:"1351",q:"К жирорастворимым витаминам относятся:",opts:["B6, H, B3, C","A, D, E, K","C, B1, B2, B6","PP, B12, B6, B1"],correct:[1]},
                    {id:"1352",q:"Средняя величина усваиваемости питательных веществ в организме составляет:",opts:["85-95%","25-35%","100%","50-60%"],correct:[0]},
                    {id:"1353",q:"Функции липидов в организме:",opts:["участие в минеральном обмене","пластические","участие в терморегуляции","энергетические","участие в водно-электролитном балансе"],correct:[1,2,3]},
                    {id:"1354",q:"Среди потребляемых жиров на долю растительных должно приходиться не менее...",opts:["50%","25%","80%","10%"],correct:[1]},
                    {id:"1355",q:"Суточная потребность человека в воде в обычных условиях составляет…",opts:["2,5 л","1 л","0,5 л","5 л"],correct:[0]},
                    {id:"1356",q:"Количество воды, выводящееся из организма через кожу и легкие в норме за сутки составляет:",opts:["5000 мл","2000 мл","100 мл","900 мл"],correct:[3]},
                    {id:"1357",q:"Содержание белков в мясных продуктах составляет около…",opts:["100%","15-20%","10%","50%"],correct:[1]},
                    {id:"1358",q:"Состав и количество продуктов питания, необходимое человеку для поддержания нормального уровня метаболизма в сутки, называется:",opts:["специфическим динамическим действием пищи","пищевым рационом","законом изодинамии питательных веществ","пищевой потребностью"],correct:[1]},
                    {id:"1359",q:"Использование «поглотителей жира» в диете…",opts:["нежелательно, так как в организм не поступают незаменимые жирные кислоты и жирорастворимые витамины","полезно, так как уменьшается поступление избытка энергии в организм","вредно, так как возрастает поступление энергии в организм"],correct:[0]}
                ]
            },
            energy: {
                name: "Раздел: Обмен энергии",
                questions: [
                    {id:"1360",q:"Распад сложных органических соединений до простых с выделением энергии называется:",opts:["рабочей прибавкой","ассимиляцией","анаболизмом","диссимиляцией"],correct:[3]},
                    {id:"1361",q:"Валовый обмен состоит из:",opts:["основного обмена","энергозатрат на поддержание температуры тела","рабочей прибавки","специфического динамического действия пищи"],correct:[0,2,3]},
                    {id:"1362",q:"Основной обмен:",opts:["зависит от рода занятий","включает энергозатраты на поддержание жизнедеятельности в покое","включает специфическое динамическое действие пищи","зависит от рабочей прибавки","является большей частью валового обмена"],correct:[1,4]},
                    {id:"1363",q:"Основной обмен зависит:",opts:["от возраста, роста, веса, пола","от количества жировой ткани в организме","от типа телосложения","от рода занятий"],correct:[0,1]},
                    {id:"1364",q:"В растущем организме уровень основного обмена, по сравнению со взрослыми:",opts:["выше","ниже","такой же"],correct:[0]},
                    {id:"1365",q:"Величина основного обмена у среднестатического мужчины в сутки составляет:",opts:["1000 ккал","3000 ккал","1700 ккал","2500 ккал"],correct:[2]},
                    {id:"1366",q:"При определении основного обмена необходимо соблюдать следующие условия:",opts:["исследование проводят при температуре комфорта","исследование проводят при легкой физической нагрузке","физическая нагрузка перед исследованием исключается","исследование проводят натощак","испытуемый находится в положении лежа, в состоянии эмоционального покоя","исследование проводят во время сна"],correct:[0,2,3,4]},
                    {id:"1367",q:"Назовите способы определения должного основного обмена у человека:",opts:["по специальным таблицам и формулам","по оценке пищевого рациона","методы прямой калориметрии","методы газового анализа"],correct:[0]},
                    {id:"1368",q:"Увеличение расхода энергии после приёма пищи называется:",opts:["усвояемостью пищи","основным обменом","специфическим динамическим действием пищи","изодинамией питательных веществ"],correct:[2]},
                    {id:"1369",q:"Объем энергозатрат у лиц, занимающихся особо тяжелым физическим трудом составляет:",opts:["около 2200 ккал/сут","около 7600 ккал/сут","около 4300 ккал/сут","около 3400 ккал/сут"],correct:[2]},
                    {id:"1370",q:"Суточный расход энергии у людей умственного труда составляет:",opts:["4200 - 4550ккал","6000 – 6100 ккал","2100-2450 ккал","3800 - 4000 ккал"],correct:[2]},
                    {id:"1371",q:"Валовый обмен у людей тяжелого физического труда и профессиональных спортсменов рассчитывается по формуле:",opts:["основной обмен х 1,2","основной обмен х 1,375","основной обмен х 1,755","основной обмен х 1,9","основной обмен х 1,55"],correct:[3]},
                    {id:"1372",q:"Валовый обмен у людей умственного труда рассчитывается по формуле:",opts:["основной обмен х 1,375","основной обмен х 1,9","основной обмен х 1,2","основной обмен х 1,755","основной обмен х 1,55"],correct:[2]},
                    {id:"1373",q:"При старении организма основной обмен:",opts:["снижается","возрастает","не изменяется"],correct:[0]},
                    {id:"1374",q:"Уровень обмена энергии, определяемый в стандартных условиях называется:",opts:["рабочим обменом","валовым обменом","минимальным обменом","основным обменом"],correct:[3]},
                    {id:"1375",q:"Повышение величины основного обмена наблюдается при:",opts:["гипофункции щитовидной железы","гипофункции гипофиза","гипофункции половых желез","гиперфункции щитовидной железы"],correct:[3]},
                    {id:"1376",q:"Дыхательный коэффициент при окислении белков равен:",opts:["1,5","0,7","0,85","1,0"],correct:[2]},
                    {id:"1377",q:"Дыхательный коэффициент при окислении жиров равен:",opts:["0,5","0,7","0,85","1,0"],correct:[1]},
                    {id:"1378",q:"При окислении 1 г глюкозы в организме образуется:",opts:["5,9 ккал","4,1 ккал","9,3 ккал"],correct:[1]},
                    {id:"1379",q:"При окислении 1 г жиров в организме образуется:",opts:["4,1 ккал","9,3 ккал","5,4 ккал","7,1 ккал"],correct:[1]},
                    {id:"1380",q:"При окислении 1 г белка в калориметрической бомбе выделяется:",opts:["5,4 ккал","9,3 ккал","3,75 ккал","4,1 ккал"],correct:[0]},
                    {id:"1381",q:"При окислении 1 г белков в организме образуется:",opts:["7,4 ккал","9,3 ккал","5,4 ккал","4,1 ккал"],correct:[3]},
                    {id:"1382",q:"Принцип, на котором основана прямая калориметрия заключается в...",opts:["измерении тепла,потребляемого организмом","исследовании газообмена организма","измерение тепла, выделенного организмом в окружающую среду"],correct:[2]},
                    {id:"1383",q:"Конечными продуктами окисления жиров и углеводов в организме являются:",opts:["углекислый газ, вода и аммиак","углекислый газ и вода","мочевина, мочевая кислота и креатинин","углекислый газ и аммиак"],correct:[1]},
                    {id:"1384",q:"В каком ответе правильно указаны калорические коэффициенты для: а) белков, б) жиров, в) углеводов?",opts:["а – 9,3,б – 4,1, в – 4,1","а - 4,1, б – 9,3, в – 4,1","а – 9,3, б – 9,3, в – 4,1","а – 4,1, б – 4,1, в – 9,3"],correct:[1]},
                    {id:"1385",q:"В каком ответе правильно указаны калорические эквиваленты кислорода для: а) белков, б) жиров, в) углеводов?",opts:["а – 9,3, б – 4,1, в – 4,1","а – 9,3, б – 9,3, в – 4,1","а – 4,1, б – 4,1, в – 9,3","а – 4,8, б – 4,7, в – 5,1"],correct:[3]},
                    {id:"1386",q:"У какого животного на 1 кг массы выделится больше тепла?",opts:["у слона","у мыши","у собаки","у лошади"],correct:[1]},
                    {id:"1387",q:"Дыхательным коэффициентом называют:",opts:["отношение О2 поглощенного к О2 выделенному","отношение О2 выделенного к CO2 поглощенному","отношение CO2 поглощенного к CO2 выделенному","отношение выделенного CO2 к поглощенному О2"],correct:[3]},
                    {id:"1388",q:"Количество тепла, освобождаемое организмом при потреблении 1 л O2 называется:",opts:["дыхательным коэффициентом","азотистым коэффициентом","калорическим эквивалентом вещества","калорическим эквивалентом кислорода"],correct:[3]},
                    {id:"1389",q:"Физическая калорическая ценность выше физиологической для:",opts:["витаминов","жиров","углеводов","белков"],correct:[3]},
                    {id:"1390",q:"При сгорании белка в калориметре конечными продуктами являются:",opts:["вода, мочевина","углекислый газ, вода, азот","углекислый газ, вода","углекислый газ, аммиак"],correct:[1]},
                    {id:"1391",q:"В организме белки окисляются до следующих конечных продуктов:",opts:["углекислый газ, вода","углекислый газ, аммиак","вода, мочевина, аммиак","углекислый газ, вода, мочевина"],correct:[3]},
                    {id:"1392",q:"По объемам выделенного CO2 и поглощенного O2 можно определить величину основного обмена методом:",opts:["прямой калориметрии","неполного газового анализа","полного газового анализа","химической калориметрии"],correct:[2]},
                    {id:"1393",q:"Правило Рубнера определяет:",opts:["образование энергии в зависимости от пола","образование энергии в зависимости от возраста","образование энергии на единицу поверхности тела","образование энергии на единицу массы тела"],correct:[2]},
                    {id:"1394",q:"Для совершения внешней работы используется около:",opts:["50-60% от основного обмена","30-40 % суточных энергозатрат","20-30 % суточных энергозатрат","10-20 % суточных энергозатрат"],correct:[3]},
                    {id:"1395",q:"В течение суток в организме взрослого человека образуется АТФ в количестве:",opts:["5-10 кг","1-3 кг","50-70 кг","200-250 кг"],correct:[2]},
                    {id:"1396",q:"В условиях основного обмена количество энергии, выделяемое в виде тепла составит:",opts:["60% от уровня рабочей прибавки","100% от уровня основного обмена","20% от уровня основного обмена","40% от уровня основного обмена"],correct:[1]},
                    {id:"1397",q:"Для совершения внешней работы организм не может использовать:",opts:["энергию химических связей","механическую энергию","электрическую энергию","тепловую энергию"],correct:[3]},
                    {id:"1398",q:"Согласно закону Гесса…",opts:["тепловой эффект химического процесса определяется его начальным и конечным состоянием и не зависит от промежуточных стадий","скорость биохимических реакций при росте температуры на 10 градусов увеличивается в 2 и более раз","количество энергии в изолированной системе всегда неизменно","тепловой эффект химического процесса зависит от числа стадий, через которые он проходит"],correct:[0]},
                    {id:"1399",q:"Первичная теплота – это...",opts:["тепло, образуемое в организме при совершении работы","тепло на этапе синтеза сложных соединений","тепло, выделяемое в организме на этапе синтеза АТФ","тепло, выделяемое в организме на этапе использования АТФ для работы"],correct:[2]},
                    {id:"1400",q:"Вторичная теплота – это...",opts:["тепло, выделяемое в организме на этапе синтеза АТФ","тепло, выделяемое в организме на этапе использования АТФ для работы","тепло на этапе синтеза сложных соединений","тепло, расходуемое в организме на совершение работы"],correct:[1]},
                    {id:"1401",q:"Калория – это…",opts:["единица измерения тепла, равна 0,239 джоуля","единица измерения тепла, равна 2,4 джоуля","единица измерения тепла, равная 1 ватт","единица измерения тепла, равна 4,2 джоуля"],correct:[3]},
                    {id:"1402",q:"Количество тепла, выделяемое при сгорании 1 г пищевого вещества в бомбе Бертло, называется:",opts:["калорическим эквивалентом кислорода","физиологической калорической ценностью","физической калорической ценностью","дыхательным коэффициентом"],correct:[2]},
                    {id:"1403",q:"У женщин основной обмен в сравнении с мужчинами:",opts:["ниже на 10-15 %","ниже на 30-40%","выше на 10-15 %","одинаков"],correct:[0]},
                    {id:"1404",q:"Теплопродукция в организме является следствием...",opts:["второго закона термодинамики","закона Гесса","баланса между теплопродукцией и теплоотдачей","правила Рубнера"],correct:[0]},
                    {id:"1405",q:"Какая пища имеет наиболее выраженное специфическое динамическое действие?",opts:["жирная","углеводная","смешанная","белковая"],correct:[3]},
                    {id:"1406",q:"Величина теплопродукции после приема углеводной пищи:",opts:["увеличивается на 10-20 %","не изменяется","уменьшается на 10-20 %","увеличивается на 30-40 %"],correct:[0]},
                    {id:"1407",q:"Согласно правилу Вант-Гоффа-Аррениуса…",opts:["количество энергии, выделяемой при утилизации веществ, зависит от начальных и конечных продуктов","тепловой эффект химического процесса определяется его начальным и конечным состоянием","скорость биохимических реакций при увеличении температуры на 10 градусов, возрастает в 2-3 раза","количество энергии в изолированной системе всегда неизменно"],correct:[2]},
                    {id:"1408",q:"Величина теплопродукции после приема белковой пищи:",opts:["увеличивается на 30-40 %","не изменяется","увеличивается на 10-20%","уменьшается на 10-20%"],correct:[0]},
                    {id:"1409",q:"Величина основного обмена у среднестатического мужчины составляет:",opts:["1 ккал/кг/час","2 ккал/кг/час","10 ккал/кг/час","3 ккал/кг/час"],correct:[0]},
                    {id:"1410",q:"Какое вещество является универсальным макроэргом в организме?",opts:["коэнзим А","аденозинтрифосфат","сукцинат","аденозиндифосфат","пируват"],correct:[1]}
                ]
            }
        };

        // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ---
        let activeQuestions = [];
        let currentIndex = 0;
        let userAnswers = {}; 
        let currentMode = 'default';
        const storageKey = 'physio_quiz_metabolism_v2'; // Новый ключ для сохранения

        // --- DOM ЭЛЕМЕНТЫ ---
        const screens = {
            start: document.getElementById('start-screen'),
            quiz: document.getElementById('quiz-screen'),
            result: document.getElementById('result-screen')
        };
        const resumeBtn = document.getElementById('resume-block');
        const quizFooter = document.getElementById('quiz-footer');
        const cardContainer = document.getElementById('question-card');
        const qIdEl = document.getElementById('q-id-display');
        const qTextEl = document.getElementById('q-text');
        const optionsList = document.getElementById('options-list');
        const mainBtn = document.getElementById('main-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const themeToggleBtns = document.querySelectorAll('.theme-toggle');
        const mistakesBtnEnd = document.getElementById('mistakes-btn-end');
        const mistakesBtnStart = document.getElementById('mistakes-btn-start');
        const progressPill = document.getElementById('progress-pill');
        const topicListEl = document.getElementById('topic-list');

        // --- ИНИЦИАЛИЗАЦИЯ ---
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            populateTopics();
            const savedData = JSON.parse(localStorage.getItem(storageKey));
            if (savedData && savedData.answers) {
                const hasMistakes = Object.values(savedData.answers).some(a => a && a.isSubmitted && !a.isCorrect);
                if (hasMistakes) {
                    mistakesBtnStart.style.display = 'flex';
                }
                if(savedData.rawQuestions && savedData.rawQuestions.length > 0) {
                     resumeBtn.style.display = 'block';
                }
            }
            themeToggleBtns.forEach(btn => btn.onclick = toggleTheme);
        });
        
        function populateTopics() {
            for (const key in topicData) {
                const topic = topicData[key];
                const label = document.createElement('label');
                label.className = 'topic-choice';
                label.innerHTML = `
                    <input type="checkbox" class="topic-checkbox" data-topic-key="${key}" checked>
                    ${topic.name}
                    <span>(${topic.questions.length} вопр.)</span>
                `;
                topicListEl.appendChild(label);
            }
        }
        
        function toggleSelectAll(button) {
            const checkboxes = document.querySelectorAll('.topic-checkbox');
            const allSelected = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allSelected);
            button.textContent = allSelected ? "Выбрать все" : "Снять выделение";
        }

        // --- ЛОГИКА ТЕМЫ ---
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = (currentTheme === 'dark') ? 'light' : 'dark';
            if (newTheme === 'light') {
                document.body.removeAttribute('data-theme');
            } else {
                document.body.setAttribute('data-theme', newTheme);
            }
            localStorage.setItem('physio_theme', newTheme);
            document.querySelectorAll('.theme-toggle i').forEach(btn => {
                const icon = btn.classList;
                if (icon.contains('fa-moon') || icon.contains('fa-sun')) {
                    icon.remove(newTheme === 'dark' ? 'fa-moon' : 'fa-sun');
                    icon.add(newTheme === 'dark' ? 'fa-sun' : 'fa-moon');
                }
            });
        }

        function loadTheme() {
            const theme = localStorage.getItem('physio_theme') || 'light';
            if (theme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
            } else {
                document.body.removeAttribute('data-theme');
            }
        }
        
        function goHome() {
            switchScreen('start');
        }

        // --- ЛОГИКА СТАРТА ТЕСТА ---
        function startQuiz(mode) {
            currentMode = mode;
            
            if (mode === 'resume') {
                if (!loadProgress()) {
                    alert("Сохраненные данные не найдены. Начинаем заново.");
                    startQuiz('new');
                    return;
                }
            } else {
                activeQuestions = [];
                currentIndex = 0;

                if (mode === 'mistakes') {
                    const savedData = JSON.parse(localStorage.getItem(storageKey));
                    let allMistakeIDs = [];
                    if (savedData && savedData.answers) {
                         userAnswers = savedData.answers; 
                         for (const id in userAnswers) {
                             userAnswers[id].selected = new Set(userAnswers[id].selected); 
                             if (!userAnswers[id].isCorrect) {
                                 allMistakeIDs.push(id);
                             }
                         }
                    }

                    if (allMistakeIDs.length === 0) {
                         alert("Нет сохраненных ошибок для работы!");
                         return;
                    }
                    
                    let fullData = [];
                    for (const key in topicData) {
                        topicData[key].questions.forEach(q => {
                            fullData.push({...q, topic: topicData[key].name });
                        });
                    }
                    
                    activeQuestions = fullData.filter(q => allMistakeIDs.includes(q.id.toString()));
                    
                    activeQuestions.forEach(q => {
                        userAnswers[q.id] = { selected: new Set(), isSubmitted: false, isCorrect: false };
                    });

                } else { // 'new' or 'shuffle'
                    const selectedKeys = Array.from(document.querySelectorAll('.topic-checkbox:checked')).map(cb => cb.dataset.topicKey);
                    if (selectedKeys.length === 0) { alert("Выберите хотя бы одну тему!"); return; }

                    selectedKeys.forEach(key => {
                        topicData[key].questions.forEach(q => {
                            activeQuestions.push({...JSON.parse(JSON.stringify(q)), topic: topicData[key].name });
                        });
                    });
                    
                    if (activeQuestions.length === 0) { alert("В выбранных темах нет вопросов."); return; }

                    if (mode === 'shuffle') {
                        shuffleArray(activeQuestions);
                        activeQuestions.forEach(q => {
                            const correctOriginalTexts = q.correct.map(idx => q.opts[idx]);
                            shuffleArray(q.opts);
                            q.correct = correctOriginalTexts.map(text => q.opts.findIndex(opt => opt === text));
                        });
                    }
                    userAnswers = {};
                    localStorage.removeItem(storageKey);
                }
            }

            switchScreen('quiz');
            renderQuestion(true);
        }
        
        // --- ЛОГИКА РЕНДЕРА ВОПРОСА ---
        function renderQuestion(isFirstLoad = false) {
            const q = activeQuestions[currentIndex];
            if (!q) return;

            if (!userAnswers[q.id]) {
                userAnswers[q.id] = { selected: new Set(), isSubmitted: false, isCorrect: false };
            }
            const state = userAnswers[q.id];

            progressPill.textContent = `${currentIndex + 1} / ${activeQuestions.length}`;
            qIdEl.textContent = q.topic; 
            qTextEl.textContent = q.q;

            cardContainer.style.animation = 'none';
            if (!isFirstLoad) {
                void cardContainer.offsetWidth; 
                cardContainer.style.animation = `fadeIn 0.3s ease-out`;
            }

            optionsList.innerHTML = '';
            q.opts.forEach((optText, idx) => {
                const div = document.createElement('div');
                div.className = 'option';
                div.innerHTML = `<div class="option-marker"></div><div class="option-text">${optText}</div>`;
                const marker = div.querySelector('.option-marker');

                if (state.isSubmitted) {
                    div.classList.add('disabled');
                    if (q.correct.includes(idx)) { div.classList.add('correct'); marker.innerHTML = '<i class="fas fa-check"></i>'; }
                    else if (state.selected.has(idx)) { div.classList.add('incorrect'); marker.innerHTML = '<i class="fas fa-times"></i>'; }
                    if (q.correct.includes(idx) && !state.selected.has(idx)) { div.classList.add('missed'); }
                } else {
                    if (state.selected.has(idx)) { div.classList.add('selected'); marker.innerHTML = '<i class="fas fa-check"></i>'; }
                    div.onclick = () => toggleOption(q.id, idx);
                }
                optionsList.appendChild(div);
            });
            
            updateFooter(state);
        }

        function toggleOption(qId, idx) {
            const state = userAnswers[qId];
            if (state.isSubmitted) return;
            if (state.selected.has(idx)) state.selected.delete(idx);
            else state.selected.add(idx);
            
            const options = document.querySelectorAll('.option');
            options.forEach((opt, i) => { 
                if (i === idx) {
                    opt.classList.toggle('selected');
                    opt.querySelector('.option-marker').innerHTML = state.selected.has(idx) ? '<i class="fas fa-check"></i>' : '';
                }
            });
            updateFooter(state);
        }

        // --- ЛОГИКА ФУТЕРА/КНОПОК ---
        function updateFooter(state) {
            prevBtn.disabled = (currentIndex === 0);
            nextBtn.disabled = (currentIndex === activeQuestions.length - 1);
            
            if (state.isSubmitted) {
                mainBtn.textContent = "Далее";
                mainBtn.disabled = false;
                mainBtn.className = 'action-btn';
                if(state.isCorrect) mainBtn.classList.add('correct');
                else mainBtn.classList.add('incorrect');
                
                if (currentIndex === activeQuestions.length - 1) {
                    mainBtn.textContent = "Завершить";
                }
            } else {
                mainBtn.textContent = "Ответить";
                mainBtn.disabled = (state.selected.size === 0);
                mainBtn.className = 'action-btn';
            }
        }
        
        function handleMainClick() {
            const state = userAnswers[activeQuestions[currentIndex].id];
            if (state.isSubmitted) {
                if (currentIndex < activeQuestions.length - 1) {
                    nextQ();
                } else {
                    finishQuiz();
                }
            } else {
                checkAnswer();
            }
        }

        function checkAnswer() {
            const q = activeQuestions[currentIndex];
            const state = userAnswers[q.id];
            if (state.isSubmitted) return;
            state.isSubmitted = true;
            
            const userArr = Array.from(state.selected).sort();
            const correctArr = [...q.correct].sort();
            state.isCorrect = JSON.stringify(userArr) === JSON.stringify(correctArr);
            
            saveProgress();
            renderQuestion(false);
        }

        function nextQ() {
            if (currentIndex < activeQuestions.length - 1) {
                currentIndex++;
                renderQuestion(false);
            }
        }
        function prevQ() {
            if (currentIndex > 0) {
                currentIndex--;
                renderQuestion(false);
            }
        }

        // --- РЕЗУЛЬТАТЫ И СОХРАНЕНИЕ ---
        function finishQuiz() {
            let correctCount = 0;
            activeQuestions.forEach(q => {
                if(userAnswers[q.id] && userAnswers[q.id].isCorrect) { correctCount++; }
            });

            const total = activeQuestions.length;
            const percent = Math.round((correctCount / total) * 100);

            document.getElementById('final-score').textContent = `${percent}%`;
            document.getElementById('correct-val').textContent = correctCount;
            document.getElementById('error-val').textContent = total - correctCount;

            const title = document.getElementById('result-title');
            if (percent === 100) title.textContent = "Идеально!";
            else if (percent >= 80) title.textContent = "Отлично!";
            else if (percent >= 50) title.textContent = "Неплохо!";
            else title.textContent = "Стоит повторить";

            if (correctCount < total) {
                mistakesBtnEnd.style.display = 'flex';
                mistakesBtnStart.style.display = 'flex';
            } else {
                mistakesBtnEnd.style.display = 'none';
                mistakesBtnStart.style.display = 'none';
            }
            switchScreen('result');
            
            saveProgress(); 
            
            if (correctCount === total) {
                localStorage.removeItem(storageKey);
                mistakesBtnStart.style.display = 'none';
                resumeBtn.style.display = 'none';
            }
        }

        function saveProgress() {
            const serializableAnswers = {};
            let allAnswers = userAnswers;

            const saved = JSON.parse(localStorage.getItem(storageKey));
            if (saved && saved.answers) {
                const oldAnswers = saved.answers;
                 for (const id in oldAnswers) {
                     if (oldAnswers[id]) { oldAnswers[id].selected = new Set(oldAnswers[id].selected); }
                 }
                allAnswers = {...oldAnswers, ...userAnswers};
            }
            
            for (const id in allAnswers) {
                serializableAnswers[id] = { ...allAnswers[id], selected: Array.from(allAnswers[id].selected) };
            }

            const progress = {
                currentMode: currentMode,
                currentIndex: currentIndex,
                rawQuestions: activeQuestions, 
                answers: serializableAnswers
            };
            localStorage.setItem(storageKey, JSON.stringify(progress));
        }

        function loadProgress() {
            const savedData = JSON.parse(localStorage.getItem(storageKey));
            if (!savedData) return false;
            
            currentMode = savedData.currentMode;
            currentIndex = savedData.currentIndex;
            activeQuestions = savedData.rawQuestions; 
            userAnswers = savedData.answers;
            for (const id in userAnswers) {
                if (userAnswers[id]) { userAnswers[id].selected = new Set(userAnswers[id].selected); }
            }
            return true;
        }
        
        function switchScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            screens[screenName].classList.add('active');
            quizFooter.style.display = (screenName === 'quiz') ? 'block' : 'none';
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        document.addEventListener('keydown', (e) => {
            if (screens.quiz.classList.contains('active')) {
                if (e.key === 'ArrowRight') nextBtn.click();
                if (e.key === 'ArrowLeft') prevBtn.click();
                if (e.key === 'Enter') mainBtn.click();
            }
        });
        
    </script>
</body>
</html>
